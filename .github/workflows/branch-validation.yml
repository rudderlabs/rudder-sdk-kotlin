name: Branch Validation

on:
  push:
    branches:
      - 'develop'
      - 'feat/*'
      - 'fix/*'
      - 'refactor/*'
      - 'chore/*'
      - 'release/*'
      - 'hotfix/*'
    # Removed catch-all pattern to avoid duplicate runs for PR branches

jobs:
  # Lightweight code validation without artifacts
  code-validation:
    name: Code Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for detecting changes

      - name: Setup and Validate
        id: validate
        uses: ./.github/actions/setup-and-validate
        with:
          run_aar_build: 'false'

      - name: Notify Slack
        if: always()
        run: |
          chmod +x scripts/send-slack-notification.sh
          
          # Determine status
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="passed"
          else
            STATUS="failed"
          fi
          
          # Set environment variables for the script
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_REF_NAME="${{ github.ref_name }}"
          export GITHUB_EVENT_HEAD_COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          export GITHUB_SHA="${{ github.sha }}"
          export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          
          ./scripts/send-slack-notification.sh "branch" "$STATUS"

  # SonarCloud analysis for important branches
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    if: contains(fromJson('["develop", "main"]'), github.ref_name)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Run SonarCloud Analysis
        uses: ./.github/actions/sonarcloud-analysis
        with:
          sonar_token: ${{ secrets.SONAR_TOKEN }}
